# Kyokushin Karate Platform - System Architecture & Data Flow

## 1. Architecture Overview

The platform is built using a modern full-stack architecture separating the frontend user interface from the backend API logic.

*   **Frontend**: Next.js 14 (App Router), TypeScript, Tailwind CSS, Framer Motion.
*   **Backend**: Node.js, Express.js, TypeScript.
*   **Database**: PostgreSQL with Prisma ORM.
*   **Authentication**: JWT (JSON Web Tokens).

---

## 2. Role-Based Functionalities

The system defines three primary user roles, each with specific permissions and capabilities.

### ðŸ›¡ï¸ Admin (Kancho/Shihan)
Admins have full control over the entire platform.
*   **User Management**:
    *   View all users across all Dojos.
    *   Edit user details (including Belt Rank).
    *   Approve or Reject new student registrations.
    *   Delete users.
    *   Promote users to Instructors.
*   **Dojo Management**:
    *   Create, Update, and Delete Dojos.
    *   Assign Instructors to Dojos.
*   **Event & Tournament Management**:
    *   Create and Delete Events (Tournaments, Camps).
    *   Approve event registrations.
    *   **Generate Tournament Brackets** (Exclusive).
    *   Manage match results and progression.
    *   **View Tournament Fixtures**: Can see all matches and brackets at any time.
*   **System**:
    *   View global statistics (Total Users, Active Dojos, etc.).

### ðŸ¥‹ Instructor (Sensei/Senpai)
Instructors manage their specific Dojo and students.
*   **User Management**:
    *   **View Access**: Can view **ALL** students in the system (global directory).
    *   **Action Access**: Can *only* Approve, Promote, or Edit students belonging to **their own Dojo**.
    *   Invite new students via email.
    *   Approve student registrations (Preliminary approval).
*   **Belt Promotion**:
    *   Can promote students within their Dojo.
    *   **Rule**: Cannot promote a student to a rank equal to or higher than their own.
    *   History of all promotions is tracked.
*   **Event Management**:
    *   Create new Events (e.g., Dojo-specific seminars).
    *   Update details of events they created.
*   **Dojo**:
    *   View details of their assigned Dojo.

### ðŸ‘Š Student (Kohai)
Students have read-only access to most features but can interact with events.
*   **Profile**:
    *   View and update their own profile (Phone, Address, etc.).
    *   View their Belt History and Tournament Results.
*   **Events**:
    *   View upcoming events.
    *   **Register** for events (Tournaments/Camps).
    *   **Tournament Fixtures**: Cannot see who they are fighting (brackets hidden) until the match starts or Admin unlocks it.

---

## 3. Detailed Data Flows (Step-by-Step)

### A. ðŸ” Login Flow
1.  **User Action**: User visits `/login`, enters Email and Password, and clicks "Sign In".
2.  **Frontend Request**: `POST /api/auth/login` with `{ email, password }`.
3.  **Backend Processing**: Validates credentials, generates JWT.
4.  **Response**: Returns token and user info.

### B. ðŸ“ New Student Registration (Two-Step Approval)
1.  **Registration**: User registers -> Status `PENDING`.
    *   *Notification*: Email sent to User (Welcome) and Instructor (New Applicant).
2.  **Instructor Approval**:
    *   Instructor clicks "Approve".
    *   Backend sets `isInstructorApproved = true`.
    *   Status remains `PENDING`.
    *   *Notification*: Email sent to Admin (Pending Final Approval).
3.  **Admin Approval**:
    *   Admin clicks "Approve".
    *   Backend sets `membershipStatus = ACTIVE`.
    *   Generates `MembershipNumber`.
    *   *Notification*: Email sent to User (Membership Active).

### C. ðŸ¥‹ Belt Promotion Workflow
1.  **Instructor Action**: Selects student -> "Promote Belt".
2.  **Validation**:
    *   Check if Instructor has permission (Same Dojo).
    *   Check if New Belt < Instructor's Belt.
3.  **Processing**:
    *   Create `BeltHistory` record (Old Belt, New Belt, Date, Promoter).
    *   Update User's `currentBeltRank`.
4.  **Notification**: Email sent to Student (Congratulations).

### D. ðŸ† Tournament Fixtures Visibility
1.  **Draft Phase**: Brackets generated by Admin.
    *   **Admin**: Can view all matches.
    *   **Instructor/Student**: Cannot view brackets.
2.  **Locked/Live Phase**: Admin "Locks" or Starts tournament.
    *   **All Users**: Can view brackets and upcoming matches.

---

## 4. Email Notifications (8 Types)

The system handles the following automated email notifications:
1.  **Registration Confirmation**: Sent to Student upon sign-up.
2.  **New Applicant Alert**: Sent to Instructor when a student registers for their Dojo.
3.  **Instructor Approval Alert**: Sent to Admin when Instructor approves a student.
4.  **Membership Activated**: Sent to Student when Admin grants final approval.
5.  **Registration Rejection**: Sent to Student if rejected.
6.  **Belt Promotion**: Sent to Student upon rank advancement.
7.  **Event Registration**: Sent to Student upon registering for an event.
8.  **Event Reminder**: Sent to participants before the event starts.
